# 메멘토 - 신뢰 연락처 및 사망 확인 시스템 구현 가이드

## 개요
담당하신 기능:
- **생전 기능 6번**: 신뢰 연락처 등록
- **사후 기능 1번**: 사망 확인 시스템

## 생성된 파일 목록

### 1. 라우터 파일
- `trusted-contacts.js` - 신뢰 연락처 관리 라우터
- `death-verification.js` - 사망 확인 시스템 라우터
- `death-notification.js` - 사망 알림 페이지 라우터

### 2. EJS 템플릿
- `trusted-contacts.ejs` - 신뢰 연락처 관리 페이지
- `death-report.ejs` - 사망 신고 페이지 (공개 접근)
- `death-verification.ejs` - 사망 확인 페이지 (이메일 링크)
- `death-report-success.ejs` - 사망 신고 접수 완료 페이지
- `verification-complete.ejs` - 확인 완료 페이지
- `verification-error.ejs` - 인증 오류 페이지
- `death-notification.ejs` - 사망 알림 페이지 (로그인 시 표시)

### 3. 미들웨어 및 설정
- `death-notification-middleware.js` - 로그인 시 사망 알림 확인
- `package.json` - 필요한 npm 패키지 목록

## 기존 프로젝트에 통합하는 방법

### 1. 파일 배치
```
backend/
├── routes/
│   ├── trusted-contacts.js
│   ├── death-verification.js
│   └── death-notification.js
├── middlewares/
│   └── death-notification-middleware.js
├── views/
│   ├── trusted-contacts.ejs
│   ├── death-report.ejs
│   ├── death-verification.ejs
│   ├── death-report-success.ejs
│   ├── verification-complete.ejs
│   ├── verification-error.ejs
│   └── death-notification.ejs
└── data/ (자동 생성됩니다)
    ├── trusted-contacts.json
    ├── death-reports.json
    └── verification-tokens.json
```

### 2. server.js에 추가할 코드

```javascript
// 라우터 import
const trustedContactsRouter = require('./routes/trusted-contacts');
const deathVerificationRouter = require('./routes/death-verification');
const deathNotificationRouter = require('./routes/death-notification');

// 미들웨어 import
const deathNotificationMiddleware = require('./middlewares/death-notification-middleware');

// 미들웨어 등록 (로그인 미들웨어 다음에)
app.use(deathNotificationMiddleware);

// 라우터 등록
app.use('/trusted-contacts', trustedContactsRouter);
app.use('/death-verification', deathVerificationRouter);
app.use('/death-notification', deathNotificationRouter);
```

### 3. 필요한 npm 패키지 설치

```bash
npm install express express-session ejs body-parser multer nodemailer
```

## 주요 기능 설명

### 신뢰 연락처 관리
- **경로**: `/trusted-contacts`
- **기능**: 
  - 최소 2명, 최대 5명의 신뢰 연락처 등록
  - 이름, 관계, 이메일, 전화번호 관리
  - CRUD 기능 (생성, 조회, 수정, 삭제)
  - 이메일 중복 검증
  - 전화번호 자동 포맷팅

### 사망 확인 시스템

#### 1. 사망 신고 (공개 접근)
- **경로**: `/death-verification/report`
- **기능**:
  - 누구나 접근 가능한 사망 신고 양식
  - 사망확인서 PDF 업로드 (선택사항)
  - 고인의 이름과 주민번호 일부로 사용자 확인
  - 신뢰 연락처에게 자동 이메일 발송

#### 2. 사망 확인 (이메일 링크)
- **경로**: `/death-verification/verify/:token`
- **기능**:
  - 신뢰 연락처가 이메일을 통해 접근
  - 7일 유효기간
  - 사망 확인 또는 거부 선택
  - 2명 이상 확인 시 72시간 대기 시작

#### 3. 사망 알림 (로그인 시)
- **경로**: `/death-notification`
- **기능**:
  - 로그인 시 자동으로 사망 신고 확인
  - 72시간 카운트다운 표시
  - "오탐지입니다" 버튼으로 즉시 취소 가능
  - 취소하지 않으면 유언 집행 시작

## 데이터 구조

### trusted-contacts.json
```json
{
  "userId": [
    {
      "id": "timestamp",
      "name": "홍길동",
      "relationship": "가족",
      "email": "contact@example.com",
      "phone": "010-1234-5678",
      "createdAt": "2025-11-22T..."
    }
  ]
}
```

### death-reports.json
```json
{
  "reportId": {
    "id": "reportId",
    "reporterName": "신고자",
    "reporterEmail": "reporter@example.com",
    "deceasedName": "고인",
    "deceasedUserId": "userId",
    "status": "pending|confirmed|rejected|cancelled",
    "confirmations": [
      {
        "contactName": "연락처이름",
        "contactEmail": "contact@example.com",
        "confirmed": true,
        "verifiedAt": "2025-11-22T..."
      }
    ],
    "executionStartTime": "2025-11-22T...",
    "createdAt": "2025-11-22T..."
  }
}
```

## 보안 고려사항

1. **세션 인증**: 모든 개인 정보 접근은 로그인 필요
2. **토큰 기반 확인**: 이메일 링크는 암호화된 토큰 사용
3. **파일 업로드 제한**: PDF만 허용, 10MB 제한
4. **입력 검증**: 모든 사용자 입력에 대한 검증
5. **개인정보 보호**: 주민번호는 부분만 입력받음

## 개발 환경 설정

### 1. 이메일 설정 (개발용)
현재는 콘솔에 이메일 내용을 출력하도록 설정되어 있습니다.
실제 이메일 발송을 원하면 `.env` 파일에 SMTP 설정을 추가하세요:

```env
NODE_ENV=production
SMTP_HOST=your-smtp-host
SMTP_PORT=587
SMTP_USER=your-email@domain.com
SMTP_PASS=your-password
SMTP_FROM=noreply@memento.com
```

### 2. 디렉토리 구조 확인
프로그램이 자동으로 필요한 디렉토리를 생성하지만, 
권한 문제가 있을 수 있으니 미리 생성해두세요:

```bash
mkdir -p backend/data
mkdir -p backend/uploads/death-certificates
```

## 팀원들과 연동 포인트

### 1. 사용자 인증 시스템과 연동
- `req.session.userId`와 `req.session.user` 사용
- 로그인 페이지 경로: `/login`
- 대시보드 경로: `/dashboard`

### 2. 유언 집행 시스템과 연동
- 사망 확정 시 `executionStartTime` 이후 자동 실행
- 상태가 `confirmed`이고 대기시간 경과한 경우 처리

### 3. 대시보드 표시 정보
신뢰 연락처 등록 현황을 대시보드에 표시하고 싶다면:

```javascript
// 대시보드 라우터에서 사용
const trustedContacts = readTrustedContacts()[userId] || [];
const hasMinimumContacts = trustedContacts.length >= 2;
```

### 4. 관리자 기능
관리자는 `/death-verification/admin`에서 모든 사망 신고를 확인할 수 있습니다.

## 테스트 시나리오

### 1. 신뢰 연락처 등록 테스트
1. 로그인 후 `/trusted-contacts` 접근
2. 연락처 추가 (2명 이상)
3. 수정/삭제 테스트

### 2. 사망 확인 시스템 테스트
1. 공개 페이지에서 사망 신고: `/death-verification/report`
2. 콘솔에서 이메일 링크 확인
3. 이메일 링크로 확인/거부 처리
4. 로그인하여 사망 알림 페이지 확인
5. "오탐지입니다" 버튼 테스트

## 향후 확장 가능성

1. **실제 SMS 발송**: SMS 서비스 연동
2. **공공기관 연동**: 실제 사망자 정보와 연동
3. **플랫폼 API 연동**: 실제 계정 삭제/이관 기능
4. **OCR 기능**: 사망확인서 자동 인식
5. **암호화 강화**: 개인정보 암호화 수준 향상

이제 이 파일들을 기존 프로젝트의 적절한 위치에 배치하고, server.js에 라우터를 등록하시면 됩니다!
